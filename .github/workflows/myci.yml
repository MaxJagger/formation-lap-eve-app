name: Build and Push Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # ==========================================================
    # ğŸš¨ ì¶”ê°€ëœ í•´ê²° ë‹¨ê³„: Insecure Registry ì„¤ì •
    # Harbor ì¸ì¦ì„œ ë¶ˆì¼ì¹˜ ë¬¸ì œ(192.168.10.20 ì¸ì¦ì„œ vs 192.168.1.18 ì ‘ì†) í•´ê²°
    # ==========================================================
    - name: Configure Insecure Registry for Harbor (192.168.1.18)
      run: |
        # Docker ë°ëª¬ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì—¬ 192.168.1.18ì„ ë¹„ë³´ì•ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ë“±ë¡
        sudo mkdir -p /etc/docker
        # JSON í¬ë§· ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‹¨ì¼ ëª…ë ¹ìœ¼ë¡œ ì²˜ë¦¬
        echo '{ "insecure-registries": ["192.168.1.18"] }' | sudo tee /etc/docker/daemon.json
        # Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘í•˜ì—¬ ìƒˆ ì„¤ì • ì ìš©
        sudo systemctl restart docker
        echo "192.168.1.18 is now configured as an insecure registry."

    - name: Log in to Harbor Registry (192.168.1.18)
      uses: docker/login-action@v3
      with:
        # ì ‘ì† ì‹œë„ ì£¼ì†ŒëŠ” 192.168.1.18 ê·¸ëŒ€ë¡œ ìœ ì§€ (ì™¸ë¶€ IP)
        registry: 192.168.1.18
        # GitHub Secretsì— ë“±ë¡ëœ HARBOR_USERNAME, HARBOR_TOKEN ì‚¬ìš©
        username: ${{ secrets.HARBOR_USERNAME }} 
        password: ${{ secrets.HARBOR_TOKEN }}

    - name: Set image tag (SHA)
      id: vars
      run: echo "TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

    - name: Build and push image to Harbor
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        # íƒœê·¸ í˜•ì‹: 192.168.1.18/matchacake-harbor-repo/eve-app:<tag>
        tags: |
          192.168.1.18/matchacake-harbor-repo/eve-app:latest
          192.168.1.18/matchacake-harbor-repo/eve-app:${{ steps.vars.outputs.TAG }}

    - name: Print result
      run: echo "Pushed image with tag ${{ steps.vars.outputs.TAG }}"

    - name: Update deployment.yaml in manifest repo
      env:
        SHA_TAG: ${{ steps.vars.outputs.TAG }}
        GH_PAT: ${{ secrets.GH_PAT }}
        MANIFEST_REPO: ${{ secrets.MANIFEST_REPO }}
        HARBOR_REGISTRY: 192.168.1.18 # 192.168.1.18 ìœ ì§€
        HARBOR_PROJECT: matchacake-harbor-repo
      run: |
        git config --global user.email "beauriful0321@gmail.com"
        git config --global user.name "Max Jagger's GitHub Actions"

        git clone https://x-access-token:${GH_PAT}@github.com/${MANIFEST_REPO}.git
        cd $(basename ${MANIFEST_REPO})

        # deployment.yaml íŒŒì¼ ë‚´ì˜ image í•„ë“œ ì—…ë°ì´íŠ¸
        sed -i "s|image:.*|image: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/eve-app:${SHA_TAG}|" app/deployment.yaml

        git add app/deployment.yaml
        git commit -m "Update image tag to ${SHA_TAG}"
        git push
